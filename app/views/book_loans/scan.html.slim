h4 Teacher's book check and return 

nav
  .nav-wrapper
    .brand-logo style="margin-left: 20px; font-size:1.5em"
      = @teacher.name
    ul.right
      li
        .input-field
          = select_tag :acad_year, options_from_collection_for_select(AcademicYear.list_for_menu,:id,:name, @academic_year_id)
      li 
        = link_to 'Done', employee_book_loans_path(@teacher, year: params[:year])

.card-panel
  .row
    table.compact
      thead
        th Barcode
        th Title 
        th Return status
        th Return date
      tbody#book_loans

javascript:
  $(window).codeScanner({
    minEntryChars: 11,
    onScan: function($element, input) {
      var barcode = input.trim();
      $.getJSON("/book_copies/"+barcode+".json?empl="+#{@teacher.id}+"&year="+#{@academic_year_id}, null, function (data) {
        update_book_loan(data);              
      }).fail(function(){
        $(e.target).val('');
        Materialize.toast("Invalid barcode.", 5000, 'red');
      });           
    }
  });

  var update_book_loan = function (data) {
    var book = data.book_copy;
    var employeeId = book.employee.id;
    var currentUserId = #{raw current_user.try(:id) || 0};
    var acad_year = $("#acad_year option:selected").val();
    url = "/employees/"+ employeeId + "/book_loans/" + book.loans.id;
    var dataToSend = new Object();
    var today = new Date();
    dataToSend = { book_loan: { barcode: book.barcode, return_status:'R', academic_year_id: acad_year,
                                return_date: today.toISOString(), user_id: currentUserId }};
    var jsonData = JSON.stringify(dataToSend);
    $.ajax({
      type: 'PUT',
      contentType: "application/json; charset=utf-8",
      url: url,
      data: jsonData,
      dataType: 'json',
      success: function(m) {
        Materialize.toast('Book checked', 5000, 'green');
        $("tbody#book_loans").prepend("<tr><td>"+book.barcode+"</td><td>"+book.book_edition.title+"</td><td>Returned</td><td>"+today.toUTCString()+"</td></tr>");
      },
      error: function(e) {
        Materialize.toast('Book check error', 5000, 'red');
      }
    });      
  }
