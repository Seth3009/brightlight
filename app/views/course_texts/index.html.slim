h4 Textbooks for #{@course.name} (#{@course.number})

nav
  .nav-wrapper
    ul
      li
        = link_to @course
          i.material-icons chevron_left
      li.right
        = link_to course_course_texts_path(@course)
          i.material-icons.tooltipped data-position="bottom" data-delay="50" data-tooltip="Expanded view"  view_module
      li.right
        = link_to course_course_texts_path(@course, {v:'list'})
          i.material-icons.tooltipped data-position="bottom" data-delay="50" data-tooltip="List view"  list
      li.right
        a.waves-effect.waves-light.modal-trigger href="#add-new-title" 
          | Add text book
          i.material-icons.left add

#add-new-title.modal.modal-fixed-footer.ui-front
  = form_tag ({controller: "course_texts", action: "create"}) do
    .modal-content
      h5 Adding new text book
      .row      
        .input-field.col.s12
          = label_tag :title_field, 'Enter book title', class:'active'
          = text_field_tag :title_field
          = hidden_field :course_text, :course_id, {value: @course.id}
          = hidden_field :course_text, :book_title_id
      #book-cover
      #selected
    .modal-footer
      button#add-button.waves-effect.waves-light.modal-action.btn.btn-default data-disable=true disabled=true type="submit" Add
      a.waves-effect.waves-light.modal-action.modal-close.btn-flat href="#!" Cancel

  javascript:
    $(function() {
      function log(image_url,title ) {
        $("#book-cover").empty();
        $("#selected").empty()
        $("<div>").text(title).prependTo("#selected");
        $("<img>").attr("src", image_url).prependTo("#book-cover");
        $("#title_field").val("");
        $("#book-cover").scrollTop(0);
      }
      $("#title_field").autocomplete({
        source: "/book_titles.json",
        minLength: 2,
        select: function(event, ui) {
          event.preventDefault();
          $("#course_text_book_title_id").val(ui.item.value);
          $('#add-button').prop('disabled', false);
          log(ui.item.image_url, ui.item? ui.item.label : "Nothing selected");
        }
      });
    });


- if @view_style == :list
  .card-panel
    .label Course texts
    table.compact.striped
      thead
        tr
          th Title
          th Author
          th Publisher
          th Actions

      tbody
        - @course_texts.each do |course_text|
          tr
            - if course_text.book_title.present?
              td = link_to course_text.book_title.title, course_text.book_title
              td = course_text.book_title.authors
              td = course_text.book_title.publisher
            - else
              td Missing data for Book Title id: #{course_text.book_title_id}
              td
              td
            td
              = link_to course_text, data: {:confirm => 'Are you sure?'}, :method => :delete
                i.material-icons.red-text.tooltipped data-position="bottom" data-delay="50" data-tooltip="Remove" delete
- else
  .row
    - @course_texts.each do |course_text|
      .col.s12.m2.l2
        .card.book-info
          .card-image
            - thumbnail = course_text.book_title.image_url.present? ? course_text.book_title.image_url : 'book-icon.png' 
            = image_tag(thumbnail, class: 'list_image activator')           
          .book-title.activator
            = course_text.book_title.title
          .card-action
            = link_to course_text.book_title
              i.material-icons.left.tooltipped data-position="bottom" data-delay="50" data-tooltip="Show" visibility
            = link_to course_text, data: {:confirm => 'Are you sure?'}, :method => :delete
              i.material-icons.left.red-text.tooltipped data-position="bottom" data-delay="50" data-tooltip="Remove" delete
          .card-reveal
            .card-title.grey-text
              i.material-icons.right close
            h5 = course_text.book_title.title             
            .label Author
            p = course_text.book_title.authors
            .label Publisher
            p = course_text.book_title.publisher


#add-new-title.modal.modal-fixed-footer.ui-front
  = form_tag ({controller: "course_texts", action: "create"}) do
    .modal-content
      h5 Adding new text book
      .row      
        .input-field.col.s12
          = label_tag :title_field, 'Enter book title', class:'active'
          = text_field_tag :title_field, '', class: 'title_autocomplete' 
          = hidden_field :course_text, :course_id, {value: @course.id}
          = hidden_field :course_text, :book_title_id
      .row
        .col.s3
          img#book-cover.list_image
        .col.s9
          h5#selected
          p#authors
          p#publisher
    .modal-footer
      button#add-button.waves-effect.waves-light.modal-action.btn.btn-default disabled=true type="submit" Add
      a.waves-effect.waves-light.modal-action.modal-close.btn-flat href="#!" Cancel

  javascript:
    $(document).on('focus', '.title_autocomplete', function() {
      $('.title_autocomplete').autocomplete({
        source: "/book_titles.json",
        minLength: 3,
        create: function() {
          $(this).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
            console.log("CREATE", item);
            return $( "<li>" )
              .append( "<div>" + item.label +"</div>" )
              .appendTo( ul );
          }
        },
        select: function(event, ui) {
          console.log("SELECT", ui.item);
          event.preventDefault();
          $('#add-button').prop('disabled', false);
          insert_values(ui.item);
        }
      });
      function insert_values(item ) {
        $("#course_text_book_title_id").val(item.value);
        $("#selected").html(item.title);
        $("#authors").html(item.authors);
        $("#publisher").html(item.publisher);
        $("#book-cover").attr("src", item.image_url);
        $("#title_field").val("");
        $("#book-cover").scrollTop(0);
      }
    });
